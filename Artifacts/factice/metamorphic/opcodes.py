STOP = 0x00
JUMPDEST = 0x5B
PUSH1 = 0x60
PUSH32 = 0x7F
RETURN = 0xF3
REVERT = 0xFD
INVALID = 0xFE
SELFDESTRUCT = 0xFF
CREATE2 = 0xF5
CREATE = 0xF0
CALLCODE = 0xF2
DELEGATECALL = 0xF4


def is_halting(opcode: int) -> bool:
    HALTING = [STOP, RETURN, REVERT, INVALID, SELFDESTRUCT]
    return any(opcode == h for h in HALTING)


def is_push(opcode: int) -> bool:
    return PUSH1 <= opcode <= PUSH32


def contain_opcode(runtime_code: str, opcode: int) -> bool:
    """
    TODO 检测是否存在目标且可达的opcode，but may raise FP:
    https://github.com/MrLuit/selfdestruct-detect/issues/15

    Credit:
        This function is a python implementation of code found here:
        https://github.com/MrLuit/selfdestruct-detect/blob/master/src/index.ts

    Args:
        runtime_code (str): deployed smart contract runtime bytecode as a hex string (i.e., "0x...")
        opcode (int): the opcode to search for in the runtime code

    Returns:
        bool: does the runtime code contain the given opcode?
    """
    runtime_code_bytes = bytearray.fromhex(runtime_code[2:])

    halted = False
    i = 0

    while i < len(runtime_code_bytes):

        oc = runtime_code_bytes[i]

        if oc == opcode and not halted:
            return True
        elif oc == JUMPDEST:
            halted = False
        elif is_halting(oc):
            halted = True
        elif is_push(oc):
            i += oc - PUSH1 + 0x02
            continue
        i += 1

    return False


# 测试contain_opcode
if __name__ == '__main__':
    code = "60806040523480156200001157600080fd5b506040516200108b3803806200108b833981016040819052620000349162000145565b6200004a836200005f60201b620009911760201c565b620000568282620000b8565b5050506200019f565b600080546001600160a01b03838116610100818102610100600160a81b0319851617855560405193049190911692909183917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e091a35050565b60005461010090046001600160a01b03163314620001085760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b604482015260640160405180910390fd5b6001600160601b0316600160a01b026001600160a01b0390911617600455565b80516001600160a01b03811681146200014057600080fd5b919050565b6000806000606084860312156200015b57600080fd5b620001668462000128565b9250620001766020850162000128565b60408501519092506001600160601b03811681146200019457600080fd5b809150509250925092565b610edc80620001af6000396000f3fe608060405234801561001057600080fd5b50600436106100b45760003560e01c806370e141951161007157806370e14195146101585780638124b78e1461016b578063848ec03c1461017e5780638da5cb5b14610191578063bc525652146101a7578063f2fde38b146101ba57600080fd5b806301ffc9a7146100b957806307caa21e146100e15780631ada40fb146100f65780632cad0014146101075780634b55ae53146101325780634e543b2614610145575b600080fd5b6100cc6100c7366004610a3f565b6101cd565b60405190151581526020015b60405180910390f35b6100f46100ef366004610b33565b6101f8565b005b6002546040519081526020016100d8565b61011a610115366004610b81565b61059d565b6040516001600160a01b0390911681526020016100d8565b6100f4610140366004610c42565b610723565b6100f4610153366004610c85565b610772565b61011a610166366004610ca0565b6107eb565b61011a610179366004610c85565b6108c8565b60035461011a906001600160a01b031681565b60005461010090046001600160a01b031661011a565b61011a6101b5366004610cdd565b61092c565b6100f46101c8366004610c85565b610956565b60006001600160e01b0319821663f80f604360e01b14806101f257506101f2826109ea565b92915050565b60005461010090046001600160a01b031633146102305760405162461bcd60e51b815260040161022790610cf6565b60405180910390fd5b6040516301ffc9a760e01b81526350130d5360e01b60048201526001600160a01b038216906301ffc9a79060240160206040518083038186803b15801561027657600080fd5b505afa15801561028a573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102ae9190610d19565b6102ee5760405162461bcd60e51b81526020600482015260116024820152704e6f74204f70656e436c6f6e6561626c6560781b6044820152606401610227565b806001600160a01b031663158ef93e6040518163ffffffff1660e01b815260040160206040518083038186803b15801561032757600080fd5b505afa15801561033b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061035f9190610d19565b61039d5760405162461bcd60e51b815260206004820152600f60248201526e139bdd081a5b9a5d1a585b1a5e9959608a1b6044820152606401610227565b806001600160a01b03163b602d14156103f85760405162461bcd60e51b815260206004820152601860248201527f436c6f6e65206e6f742076616c69642074656d706c61746500000000000000006044820152606401610227565b600060018360405161040a9190610d6b565b90815260200160405180910390205490506001811061047457816002610431600184610d87565b8154811061044157610441610dac565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055506104e7565b50600280546001808201835560008390527f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace90910180546001600160a01b0319166001600160a01b0385161790559054604051909182916104d6908690610d6b565b908152604051908190036020019020555b600354604051630e3ab68760e21b81526001600160a01b038481166004830152909116906338eada1c90602401600060405180830381600087803b15801561052e57600080fd5b505af1158015610542573d6000803e3d6000fd5b50505050816001600160a01b03168360405161055e9190610d6b565b604051908190038120838252907f9a1bc68d29ae4a678ea14888c65dd019ada583b85f33e2483dae925e470d0d709060200160405180910390a3505050565b60006105ab610179846107eb565b6004546040519192506001600160a01b0380841692631eb40e21928992899233926105ef928a9290821691600160a01b90046001600160601b031690602001610dee565b6040516020818303038152906040526040518563ffffffff1660e01b815260040161061d9493929190610e2a565b600060405180830381600087803b15801561063757600080fd5b505af115801561064b573d6000803e3d6000fd5b5050600354604051630e3ab68760e21b81526001600160a01b03858116600483015290911692506338eada1c9150602401600060405180830381600087803b15801561069657600080fd5b505af11580156106aa573d6000803e3d6000fd5b50505050846040516106bc9190610d6b565b6040518091039020816001600160a01b0316846040516106dc9190610d6b565b60405180910390207f58689b2920c59f090416ecf8b77869a3026ebcdf93291be87ff14cc7739565e9876040516107139190610e7d565b60405180910390a4949350505050565b60005461010090046001600160a01b031633146107525760405162461bcd60e51b815260040161022790610cf6565b6001600160601b0316600160a01b026001600160a01b0390911617600455565b60005461010090046001600160a01b031633146107a15760405162461bcd60e51b815260040161022790610cf6565b600380546001600160a01b0319166001600160a01b0383169081179091556040517ff811902d0aa96fa0dd89bebe8fc3818fa2132b9437abc92ed35639cc82da6d7c90600090a250565b6000806001836040516107fe9190610d6b565b908152602001604051809103902054905060018110156108535760405162461bcd60e51b815260206004820152601060248201526f496e76616c69642054656d706c61746560801b6044820152606401610227565b6002610860600183610d87565b8154811061087057610870610dac565b6000918252602090912001546001600160a01b03169150816108c25760405162461bcd60e51b815260206004820152600b60248201526a4e6f2054656d706c61746560a81b6044820152606401610227565b50919050565b6000604051733d602d80600a3d3981f3363d3d373d3d3d363d7360601b81528260601b60148201526e5af43d82803e903d91602b57fd5bf360881b60288201526037816000f09150506001600160a01b03811661092757610927610e90565b919050565b6002818154811061093c57600080fd5b6000918252602090912001546001600160a01b0316905081565b60005461010090046001600160a01b031633146109855760405162461bcd60e51b815260040161022790610cf6565b61098e81610991565b50565b600080546001600160a01b03838116610100818102610100600160a81b0319851617855560405193049190911692909183917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e091a35050565b60006001600160e01b031982166340925bc760e11b14806101f257506101f28260006307f5828d60e41b6001600160e01b0319831614806101f257506001600160e01b031982166301ffc9a760e01b146101f2565b600060208284031215610a5157600080fd5b81356001600160e01b031981168114610a6957600080fd5b9392505050565b634e487b7160e01b600052604160045260246000fd5b600067ffffffffffffffff80841115610aa157610aa1610a70565b604051601f8501601f19908116603f01168101908282118183101715610ac957610ac9610a70565b81604052809350858152868686011115610ae257600080fd5b858560208301376000602087830101525050509392505050565b600082601f830112610b0d57600080fd5b610a6983833560208501610a86565b80356001600160a01b038116811461092757600080fd5b60008060408385031215610b4657600080fd5b823567ffffffffffffffff811115610b5d57600080fd5b610b6985828601610afc565b925050610b7860208401610b1c565b90509250929050565b60008060008060808587031215610b9757600080fd5b843567ffffffffffffffff80821115610baf57600080fd5b610bbb88838901610afc565b95506020870135915080821115610bd157600080fd5b610bdd88838901610afc565b94506040870135915080821115610bf357600080fd5b610bff88838901610afc565b93506060870135915080821115610c1557600080fd5b508501601f81018713610c2757600080fd5b610c3687823560208401610a86565b91505092959194509250565b60008060408385031215610c5557600080fd5b610c5e83610b1c565b915060208301356001600160601b0381168114610c7a57600080fd5b809150509250929050565b600060208284031215610c9757600080fd5b610a6982610b1c565b600060208284031215610cb257600080fd5b813567ffffffffffffffff811115610cc957600080fd5b610cd584828501610afc565b949350505050565b600060208284031215610cef57600080fd5b5035919050565b6020808252600990820152682737ba1037bbb732b960b91b604082015260600190565b600060208284031215610d2b57600080fd5b81518015158114610a6957600080fd5b60005b83811015610d56578181015183820152602001610d3e565b83811115610d65576000848401525b50505050565b60008251610d7d818460208701610d3b565b9190910192915050565b600082821015610da757634e487b7160e01b600052601160045260246000fd5b500390565b634e487b7160e01b600052603260045260246000fd5b60008151808452610dda816020860160208601610d3b565b601f01601f19169290920160200192915050565b606081526000610e016060830186610dc2565b6001600160a01b03949094166020830152506001600160601b0391909116604090910152919050565b608081526000610e3d6080830187610dc2565b8281036020840152610e4f8187610dc2565b6001600160a01b038616604085015283810360608501529050610e728185610dc2565b979650505050505050565b602081526000610a696020830184610dc2565b634e487b7160e01b600052600160045260246000fdfea2646970667358221220b789d70d42ff77ad7a60329fa29dcc48e3af8378d53e1d89f8a5809c8bd6f59d64736f6c634300080900330000000000000000000000006eebae27d69fa80f0e4c0e973a2fed218a56880c00000000000000000000000047e2382d9e1e985ba1f4064e7d8d753fab99f209000000000000000000000000000000000000000000000000000000000000005a"
    contain_create = contain_opcode(code, CREATE)
    contain_create2 = contain_opcode(code, CREATE2)
    print(f"Contain CREATE: {contain_create}, CREATE2: {contain_create2}")
